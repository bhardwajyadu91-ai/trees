<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TreeHeight Pro V12</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; background: #000; color: white; overflow: hidden; touch-action: none; }
        #capture-area { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Top Readout */
        #readout { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 12px; border-radius: 15px; text-align: center; width: 85%; border: 1px solid #444; pointer-events: auto; }
        #height-res { font-size: 2.5em; font-weight: bold; color: #2ecc71; margin: 2px 0; }
        
        /* Crosshair */
        #center-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #crosshair { width: 60px; height: 60px; border: 2px solid #ff4757; border-radius: 50%; position: relative; color: #ff4757; }
        #crosshair::before { content: ''; position: absolute; top: 20%; left: 50%; width: 2px; height: 60%; background: currentColor; transform: translateX(-50%); }
        #crosshair::after { content: ''; position: absolute; top: 50%; left: 20%; width: 60%; height: 2px; background: currentColor; transform: translateY(-50%); }
        
        /* NEW: Floating Settings Panel (Lifted 80px to avoid Nav Bar) */
        #settings-panel { 
            position: absolute; bottom: 100px; left: 15px; width: 60%; 
            background: rgba(30, 30, 30, 0.9); padding: 12px; border-radius: 20px; 
            border: 1px solid #555; pointer-events: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; gap: 8px; }
        .group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .group span { font-size: 9px; text-transform: uppercase; opacity: 0.7; margin-bottom: 3px; }
        input { background: rgba(255,255,255,0.1); border: none; border-radius: 5px; color: #2ecc71; font-weight: bold; text-align: center; font-size: 16px; width: 100%; padding: 5px 0; outline: none; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .small-btn { background: #444; padding: 10px 5px; border-radius: 10px; font-size: 10px; border: none; color: white; cursor: pointer; font-weight: bold; }
        .btn-flat { background: #1b7e42; }
        .btn-save { background: #2980b9; grid-column: span 2; }

        /* Floating Main Action Button */
        #main-btn { 
            position: absolute; bottom: 100px; right: 20px; width: 90px; height: 90px; 
            border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); color: white; 
            font-weight: bold; font-size: 15px; cursor: pointer; pointer-events: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .btn-measure { background: #2ecc71; }
        .btn-reset { background: #e67e22; }
    </style>
</head>
<body>

<div id="capture-area">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    
    <div id="hud">
        <div id="readout">
            <input type="text" id="species" placeholder="Tap to name tree species..." style="background:none; border:none; color:#bbb; width:100%; font-size:12px; text-align:center;">
            <div id="height-res">-- m</div>
            <div id="info-res" style="font-size: 10px; opacity: 0.6;">Align Horizon Triangle at eye-level first</div>
        </div>

        <div id="center-ui"><div id="crosshair"></div></div>
        
        <div id="settings-panel">
            <div class="row">
                <div class="group"><span>Steps</span><input type="number" id="step-count" value="15"></div>
                <div class="group"><span>SlopeÂ°</span><input type="number" id="ground-angle" value="0"></div>
                <div class="group"><span>Pace</span><input type="number" id="pace-val" value="0.75" step="0.01"></div>
            </div>
            <div class="btn-grid">
                <button class="small-btn btn-flat" onclick="setFlat()">FLAT (0Â°)</button>
                <button class="small-btn" onclick="snapSlope()">SNAP SLOPE</button>
                <button class="small-btn" onclick="calibratePace()">PACE CALIB</button>
                <button class="small-btn btn-save" onclick="saveImage()">ðŸ“¸ SAVE TO GALLERY</button>
            </div>
        </div>

        <button id="main-btn" class="btn-measure" onclick="handleMainAction()">START</button>
    </div>
</div>

<script>
    let step = 0, angleTop = 0, offset = 0, smoothedPitch = 90, smoothedRoll = 0, filter = 0.15;
    const video = document.getElementById('video'), canvas = document.getElementById('overlay'), ctx = canvas.getContext('2d'), mainBtn = document.getElementById('main-btn');

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    async function startApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            window.addEventListener('deviceorientation', (e) => {
                smoothedPitch = (e.beta * filter) + (smoothedPitch * (1 - filter));
                smoothedRoll = (e.gamma * filter) + (smoothedRoll * (1 - filter));
                document.getElementById('crosshair').style.borderColor = Math.abs(smoothedRoll) < 5 ? "#2ecc71" : "#ff4757";
            });
            step = 1; updateUI();
            requestAnimationFrame(drawLoop);
        } catch (err) { alert("Enable Sensors/Camera"); }
    }

    function drawLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const currentPitch = smoothedPitch - offset;
        const horizonDiff = currentPitch - 90; 
        const horizonY = (canvas.height / 2) + ((horizonDiff / 50) * canvas.height);

        // Angle HUD
        ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.font = "14px monospace"; ctx.textAlign = "right";
        ctx.fillText(Math.abs(horizonDiff).toFixed(1) + "Â°", canvas.width - 20, canvas.height / 2);

        if (step >= 1) {
            ctx.fillStyle = "rgba(52, 152, 219, 0.9)";
            ctx.beginPath(); ctx.moveTo(canvas.width/2, horizonY);
            ctx.lineTo(canvas.width/2-20, horizonY+25); ctx.lineTo(canvas.width/2+20, horizonY+25);
            ctx.fill();
        }
        requestAnimationFrame(drawLoop);
    }

    function setFlat() { document.getElementById('ground-angle').value = 0; }
    function snapSlope() { document.getElementById('ground-angle').value = Math.abs(90 - smoothedPitch).toFixed(1); }
    function calibratePace() {
        let p = prompt("Walk 5 meters. How many steps?");
        if(p) document.getElementById('pace-val').value = (5 / parseInt(p)).toFixed(2);
    }

    function saveImage() {
        html2canvas(document.querySelector("#capture-area")).then(canvas => {
            let link = document.createElement('a');
            link.download = `Tree_${document.getElementById('species').value || 'Data'}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function handleMainAction() {
        if (step === 0) startApp();
        else if (step === 1) {
            angleTop = smoothedPitch - offset;
            const s = parseFloat(document.getElementById('step-count').value), p = parseFloat(document.getElementById('pace-val').value);
            const g = parseFloat(document.getElementById('ground-angle').value) * (Math.PI / 180);
            const hDist = (s * p) * Math.cos(g);
            const height = (hDist * Math.tan((angleTop - 90) * (Math.PI / 180))) + 1.6;
            document.getElementById('height-res').innerText = height.toFixed(2) + " m";
            document.getElementById('info-res').innerText = `H-Dist: ${hDist.toFixed(1)}m | Slope: ${document.getElementById('ground-angle').value}Â°`;
            step = 2;
        } else { step = 1; document.getElementById('height-res').innerText = "-- m"; }
        updateUI();
    }

    function updateUI() {
        mainBtn.innerHTML = (step === 1) ? "MARK<br>TOP" : "RESET";
        mainBtn.className = (step === 1) ? "btn-measure" : "btn-reset";
    }
</script>
</body>
</html>
