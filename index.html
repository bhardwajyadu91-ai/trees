<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TreeHeight Pro V5</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: white; overflow: hidden; touch-action: none; }
        #camera-container { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; 
               display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #crosshair { 
            width: 80px; height: 80px; border: 2px solid #ff4757; border-radius: 50%; 
            position: relative; transition: 0.2s; color: #ff4757;
        }
        #crosshair::before { content: ''; position: absolute; top: 10%; left: 50%; width: 2px; height: 80%; background: currentColor; transform: translateX(-50%); }
        #crosshair::after { content: ''; position: absolute; top: 50%; left: 10%; width: 80%; height: 2px; background: currentColor; transform: translateY(-50%); }
        
        #readout { position: absolute; top: 30px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 12px; text-align: center; width: 85%; border: 1px solid #333; }
        #status-text { font-weight: bold; font-size: 1.1em; color: #ff4757; margin-bottom: 4px; }

        #controls { position: absolute; bottom: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; pointer-events: auto; }
        
        .settings-bar { display: flex; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 15px; width: 85%; align-items: center; }
        .input-row { display: flex; gap: 15px; font-size: 13px; align-items: center; }
        
        input[type="number"] { width: 40px; background: transparent; color: #2ecc71; border: none; font-weight: bold; border-bottom: 1px solid #2ecc71; text-align: center; outline: none; }
        
        button { padding: 18px; border-radius: 40px; border: none; color: white; font-weight: bold; font-size: 18px; width: 85%; cursor: pointer; transition: 0.3s; }
        .btn-measure { background: #2ecc71; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); }
        .btn-reset { background: #e67e22; }
        button:disabled { background: #444 !important; opacity: 0.5; color: #888; box-shadow: none; }
        
        .small-btn { color: #888; font-size: 11px; text-decoration: underline; background: none; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="video" autoplay playsinline></video>
    
    <div id="hud">
        <div id="readout">
            <div id="status-text">Ready</div>
            <div id="height-res" style="font-size: 2.2em; font-weight: bold; color: #2ecc71;">-- m</div>
            <div id="info-res" style="font-size: 0.9em; opacity: 0.7;">Select Lens & Start</div>
        </div>

        <div id="crosshair"></div>

        <div id="controls">
            <div class="settings-bar">
                <div class="input-row">
                    <label>Eye Ht: <input type="number" id="eye-height" value="1.6" step="0.1">m</label>
                    <label><input type="checkbox" id="high-accuracy" checked> High Accuracy</label>
                </div>
                <div style="display: flex; gap: 20px;">
                    <button id="calib-btn" class="small-btn" onclick="calibrate()">Calibrate Vertical</button>
                    <button id="lens-btn" class="small-btn" onclick="toggleLens()">Switch Lens (Wide)</button>
                </div>
            </div>
            
            <button id="main-btn" class="btn-measure">START CAMERA</button>
        </div>
    </div>
</div>

<script>
    let step = 0; 
    let angleBase = 0, angleTop = 0;
    let smoothedPitch = 0, smoothedRoll = 0, offset = 0;
    const filter = 0.12;
    let useWide = false;

    const video = document.getElementById('video');
    const mainBtn = document.getElementById('main-btn');
    const statusText = document.getElementById('status-text');
    const heightRes = document.getElementById('height-res');
    const infoRes = document.getElementById('info-res');
    const crosshair = document.getElementById('crosshair');
    const highAccCheck = document.getElementById('high-accuracy');

    async function toggleLens() {
        useWide = !useWide;
        document.getElementById('lens-btn').innerText = useWide ? "Using Wide Lens" : "Using Standard Lens";
        if (video.srcObject) startApp(); // Restart stream with new lens
    }

    async function startApp() {
        try {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            // Attempt to find the Ultra Wide lens
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(device => device.kind === 'videoinput');
            
            // On many phones, the last camera in the list is the wide/ultra-wide lens
            const selectedCamera = useWide && cameras.length > 1 ? cameras[cameras.length - 1] : cameras[0];

            const constraints = {
                video: {
                    deviceId: selectedCamera.deviceId ? { exact: selectedCamera.deviceId } : undefined,
                    facingMode: 'environment'
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission === 'granted') window.addEventListener('deviceorientation', handleOrientation);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
            step = 1;
            updateUI();
        } catch (err) { alert("Camera Error: " + err.message); }
    }

    function handleOrientation(e) {
        smoothedPitch = (e.beta * filter) + (smoothedPitch * (1 - filter));
        smoothedRoll = (e.gamma * filter) + (smoothedRoll * (1 - filter));

        const isLevel = Math.abs(smoothedRoll) < 4;
        const strictMode = highAccCheck.checked;

        if (isLevel) {
            crosshair.style.borderColor = "#2ecc71";
            crosshair.style.color = "#2ecc71";
            statusText.style.color = "#2ecc71";
            if (step === 1) statusText.innerText = "Level - Aim at BOTTOM";
            if (step === 2) statusText.innerText = "Level - Aim at TOP";
        } else {
            crosshair.style.borderColor = "#ff4757";
            crosshair.style.color = "#ff4757";
            statusText.style.color = "#ff4757";
            statusText.innerText = "Level Phone Side-to-Side";
        }

        if (step === 1 || step === 2) {
            mainBtn.disabled = strictMode ? !isLevel : false;
        }
    }

    function calibrate() {
        offset = smoothedPitch - 90;
        alert("Vertical calibrated.");
    }

    function updateUI() {
        if (step === 1) { mainBtn.innerText = "MARK BASE"; mainBtn.className = "btn-measure"; }
        else if (step === 2) { mainBtn.innerText = "MARK TOP"; mainBtn.className = "btn-measure"; }
        else if (step === 3) { mainBtn.innerText = "RESET"; mainBtn.className = "btn-reset"; mainBtn.disabled = false; }
    }

    mainBtn.addEventListener('click', () => {
        if (step === 0) return startApp();
        let activePitch = smoothedPitch - offset;

        if (step === 1) {
            angleBase = activePitch;
            step = 2;
            infoRes.innerText = "Base marked. Aim at top.";
        } else if (step === 2) {
            angleTop = activePitch;
            calculateHeight();
            step = 3;
        } else if (step === 3) {
            step = 1;
            heightRes.innerText = "-- m";
            infoRes.innerText = "New Measurement";
        }
        updateUI();
    });

    function calculateHeight() {
        const h_eye = parseFloat(document.getElementById('eye-height').value);
        const radBase = (90 - angleBase) * (Math.PI / 180);
        const radTop = (angleTop - 90) * (Math.PI / 180);

        const distance = h_eye / Math.tan(radBase);
        const h_above = distance * Math.tan(radTop);
        const total = h_eye + h_above;

        if (distance < 0 || !isFinite(total)) {
            heightRes.innerText = "Error";
            infoRes.innerText = "Try standing further back.";
        } else {
            heightRes.innerText = total.toFixed(2) + " m";
            infoRes.innerText = "Distance: " + distance.toFixed(1) + "m";
        }
    }
</script>
</body>
</html>
