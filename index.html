<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TreeHeight Pro – Fixed</title>

<style>
body {
    margin: 0;
    background: black;
    color: white;
    font-family: system-ui;
    overflow: hidden;
}

video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
}

/* HUD */
#hud {
    position: absolute;
    inset: 0;
    pointer-events: none;
}

/* Crosshair */
#lineV, #lineH {
    position: absolute;
    background: #2ecc71;
    opacity: 0.75;
}
#lineV { width: 2px; height: 100%; left: 50%; }
#lineH { height: 2px; width: 100%; top: 50%; }

#centerDot {
    position: absolute;
    width: 14px;
    height: 14px;
    border: 2px solid #2ecc71;
    border-radius: 50%;
    left: calc(50% - 7px);
    top: calc(50% - 7px);
}

/* Horizon */
#horizon {
    position: absolute;
    width: 300px;
    height: 2px;
    background: rgba(255,255,255,0.6);
    left: calc(50% - 150px);
    top: 50%;
}

/* Readout */
#readout {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 12px 18px;
    border-radius: 12px;
    text-align: center;
}

#angle { font-size: 0.9em; opacity: 0.85; }
#height { font-size: 1.8em; font-weight: bold; color: #2ecc71; }

/* Controls */
#controls {
    position: absolute;
    bottom: 30px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    pointer-events: auto;
}

button, input {
    font-size: 16px;
    padding: 12px 20px;
    border-radius: 30px;
    border: none;
}

button {
    background: #2ecc71;
    color: white;
    width: 80%;
}
.secondary {
    background: #555;
}
</style>
</head>

<body>
<video id="video" autoplay playsinline></video>

<div id="hud">
    <div id="readout">
        <div id="status">Press START</div>
        <div id="angle">Elevation: --°</div>
        <div id="height">-- m</div>
    </div>

    <div id="horizon"></div>
    <div id="lineV"></div>
    <div id="lineH"></div>
    <div id="centerDot"></div>

    <div id="controls">
        <input id="eyeHeight" type="number" value="1.6" step="0.1">
        <button id="startBtn">START</button>
        <button id="resetBtn" class="secondary">RESET</button>
        <button id="calibBtn" class="secondary">CALIBRATE HORIZONTAL</button>
    </div>
</div>

<script>
/* ---------------- STATE ---------------- */
let smoothPitch = 0;
let smoothRoll = 0;
let zeroOffset = 0;

let step = 0;
let baseAngle = null;
let topAngle = null;

const FILTER = 0.15;
const STABLE_COUNT = 12;
let samples = [];

/* ---------------- ELEMENTS ---------------- */
const video = document.getElementById("video");
const horizon = document.getElementById("horizon");
const angleUI = document.getElementById("angle");
const heightUI = document.getElementById("height");
const statusUI = document.getElementById("status");

/* ---------------- CAMERA ---------------- */
async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });
    video.srcObject = stream;
}

/* ---------------- ORIENTATION ---------------- */
function onOrientation(e) {
    smoothPitch = e.beta * FILTER + smoothPitch * (1 - FILTER);
    smoothRoll = e.gamma * FILTER + smoothRoll * (1 - FILTER);

    const elevation = (90 - smoothPitch) - zeroOffset;

    horizon.style.transform =
        `rotate(${-smoothRoll}deg) translateY(${elevation * 2}px)`;

    angleUI.textContent = `Elevation: ${elevation.toFixed(1)}°`;

    if (step === 1 || step === 2) {
        samples.push(elevation);
        if (samples.length > STABLE_COUNT) samples.shift();
    }
}

/* ---------------- HELPERS ---------------- */
function stableAverage() {
    if (samples.length < STABLE_COUNT) return null;
    return samples.reduce((a,b)=>a+b,0)/samples.length;
}

/* ---------------- BUTTONS ---------------- */
document.getElementById("startBtn").onclick = async () => {
    if (!video.srcObject) {
        await startCamera();
        window.addEventListener("deviceorientation", onOrientation);
        statusUI.textContent = "Aim at BASE and tap START";
        step = 1;
        samples = [];
        return;
    }

    const avg = stableAverage();
    if (avg === null) {
        alert("Hold steady for a moment");
        return;
    }

    if (step === 1) {
        baseAngle = avg;
        samples = [];
        step = 2;
        statusUI.textContent = "Aim at TOP and tap START";
    }
    else if (step === 2) {
        topAngle = avg;
        calculateHeight();
        step = 3;
        statusUI.textContent = "Result (RESET for new reading)";
    }
};

document.getElementById("resetBtn").onclick = () => {
    step = 1;
    baseAngle = null;
    topAngle = null;
    samples = [];
    heightUI.textContent = "-- m";
    statusUI.textContent = "Aim at BASE and tap START";
};

document.getElementById("calibBtn").onclick = () => {
    zeroOffset = (90 - smoothPitch);
    alert("Horizontal calibrated");
};

/* ---------------- CALCULATION ---------------- */
function calculateHeight() {
    const hEye = parseFloat(document.getElementById("eyeHeight").value);

    const θb = baseAngle * Math.PI / 180;
    const θt = topAngle * Math.PI / 180;

    if (θb >= 0) {
        alert("Base must be below eye level");
        return;
    }

    const distance = hEye / Math.abs(Math.tan(θb));
    const height = hEye + distance * Math.tan(θt);

    heightUI.textContent = `${height.toFixed(2)} m`;
}
</script>
</body>
</html>
