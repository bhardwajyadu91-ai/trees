<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TreeHeight PWA</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: white; overflow: hidden; }
        #camera-container { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* UI Overlays */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; 
               display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .crosshair { width: 30px; height: 30px; border: 2px solid white; border-radius: 50%; }
        .horizon { width: 200px; height: 2px; background: rgba(255,255,255,0.5); position: absolute; }
        
        #controls { position: absolute; bottom: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; pointer-events: auto; }
        input { padding: 12px; border-radius: 8px; border: none; width: 120px; text-align: center; font-size: 16px; }
        button { padding: 15px 30px; border-radius: 30px; border: none; background: #2ecc71; color: white; font-weight: bold; font-size: 18px; }
        
        #warning { background: rgba(231, 76, 60, 0.9); padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; }
        #readout { position: absolute; top: 20px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="video" autoplay playsinline></video>
    
    <div id="hud">
        <div id="readout">
            <div>Angle: <span id="angle-val">0</span>°</div>
            <div id="height-res" style="font-size: 1.5em; color: #2ecc71;">Height: --</div>
        </div>

        <div id="warning">⚠️ TOO CLOSE: Move back for accuracy</div>
        
        <div class="horizon" id="horizon-line"></div>
        <div class="crosshair"></div>

        <div id="controls">
            <input type="number" id="distance" placeholder="Dist to Tree (m)" value="10">
            <button id="btn-action">Measure Base</button>
        </div>
    </div>
</div>

<script>
    let step = 0; // 0: Base, 1: Top
    let angleBase = 0;
    let angleTop = 0;
    let currentPitch = 0;

    const video = document.getElementById('video');
    const angleDisp = document.getElementById('angle-val');
    const heightDisp = document.getElementById('height-res');
    const warning = document.getElementById('warning');
    const horizon = document.getElementById('horizon-line');
    const btn = document.getElementById('btn-action');

    // 1. Initialize Camera
    async function initCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
    }

    // 2. Handle Orientation (iOS requires permission)
    async function requestPermissions() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === 'granted') window.addEventListener('deviceorientation', handleOrientation);
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }
        initCamera();
        btn.innerText = "Set Base Angle";
    }

    function handleOrientation(event) {
        // Pitch (Beta) is the forward/backward tilt
        // Roll (Gamma) is the side-to-side tilt
        currentPitch = event.beta; 
        let roll = event.gamma;

        angleDisp.innerText = Math.round(currentPitch);
        
        // Visual feedback: Horizon line tilt
        horizon.style.transform = `rotate(${-roll}deg)`;

        // Warning Logic: If angle is too steep (> 60 deg)
        if (currentPitch > 60 || currentPitch < -60) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    // 3. Calculation Logic
   // 3. Calculation Logic
    btn.addEventListener('click', () => {
        if (step === 0) {
            // Start camera and sensors on first click
            if (!video.srcObject) {
                requestPermissions();
                return;
            }
            angleBase = currentPitch;
            btn.innerText = "Set Top Angle";
            btn.style.background = "#3498db";
            step = 1;
        } else if (step === 1) {
            angleTop = currentPitch;
            calculateHeight();
            btn.innerText = "Reset";
            btn.style.background = "#95a5a6";
            step = 2;
        } else {
            // Reset everything
            step = 0;
            btn.innerText = "Set Base Angle";
            btn.style.background = "#2ecc71";
            heightDisp.innerText = "Height: --";
        }
    });
    function calculateHeight() {
    const d = parseFloat(document.getElementById('distance').value);
    
    // Normalize angles: If phone is upright, beta is ~90. 
    // We want level to be 0, so we subtract 90.
    const normBase = angleBase - 90;
    const normTop = angleTop - 90;

    // Convert to Radians
    const radBase = normBase * (Math.PI / 180);
    const radTop = normTop * (Math.PI / 180);

    // Formula: Height = d * tan(top) - d * tan(base)
    // tan(top) is usually positive (looking up)
    // tan(base) is usually negative (looking down)
    const height = d * (Math.tan(radTop) - Math.tan(radBase));
    
    // Use Math.abs to ensure a positive result
    heightDisp.innerText = `Height: ${Math.abs(height).toFixed(2)}m`;
}
</script>
</body>

</html>

