<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TreeHeight Pro - Master V10</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: white; overflow: hidden; touch-action: none; }
        #capture-area { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #crosshair { width: 60px; height: 60px; border: 2px solid #ff4757; border-radius: 50%; position: relative; color: #ff4757; }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: currentColor; }
        #crosshair::before { top: 20%; left: 50%; width: 2px; height: 60%; transform: translateX(-50%); }
        #crosshair::after { top: 50%; left: 20%; width: 60%; height: 2px; transform: translateY(-50%); }
        #readout { position: absolute; top: 20px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 12px; text-align: center; width: 85%; border: 1px solid #333; }
        #height-res { font-size: 2.5em; font-weight: bold; color: #2ecc71; }
        #controls { position: absolute; bottom: 15px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: auto; }
        .settings-bar { background: rgba(0,0,0,0.9); padding: 12px; border-radius: 15px; width: 92%; font-size: 11px; border: 1px solid #444; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; gap: 5px; }
        .group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        input { background: none; border: none; border-bottom: 2px solid #2ecc71; color: #2ecc71; font-weight: bold; text-align: center; font-size: 16px; width: 55px; outline: none; }
        button { padding: 16px; border-radius: 35px; border: none; color: white; font-weight: bold; font-size: 18px; width: 90%; cursor: pointer; }
        .btn-measure { background: #2ecc71; }
        .btn-reset { background: #e67e22; }
        .small-btn { background: #444; padding: 7px; border-radius: 6px; font-size: 10px; border: none; color: white; cursor: pointer; margin: 2px; }
        .btn-flat { background: #27ae60; } /* Special color for Flat Ground button */
    </style>
</head>
<body>

<div id="capture-area">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="hud">
        <div id="readout">
            <div id="status-text" style="color:#ff4757; font-weight:bold; font-size:12px;">READY</div>
            <div id="height-res">-- m</div>
            <div id="info-res" style="font-size: 10px; opacity: 0.7;">Steps x Pace = Distance</div>
        </div>
        <div id="crosshair"></div>
        <div id="controls">
            <div class="settings-bar">
                <div class="row">
                    <div class="group"><span>Steps Walked</span><input type="number" id="step-count" value="15"></div>
                    <div class="group"><span>Ground SlopeÂ°</span><input type="number" id="ground-angle" value="0" step="0.1"></div>
                    <div class="group"><span>Pace (m)</span><input type="number" id="pace-val" value="0.75" step="0.01"></div>
                </div>
                <div class="row" style="justify-content: center; flex-wrap: wrap;">
                    <button class="small-btn btn-flat" onclick="setFlat()">Flat Ground (0Â°)</button>
                    <button class="small-btn" onclick="snapSlope()">Snap Slope</button>
                    <button class="small-btn" onclick="calibratePace()">Calibrate Pace</button>
                    <button class="small-btn" onclick="saveImage()">ðŸ“¸ Save Photo</button>
                </div>
            </div>
            <button id="main-btn" class="btn-measure" onclick="handleMainAction()">START CAMERA</button>
        </div>
    </div>
</div>

<script>
    let step = 0; 
    let angleTop = 0, offset = 0, smoothedPitch = 90, smoothedRoll = 0;
    const filter = 0.15;
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const mainBtn = document.getElementById('main-btn');

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    async function startApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            window.addEventListener('deviceorientation', (e) => {
                smoothedPitch = (e.beta * filter) + (smoothedPitch * (1 - filter));
                smoothedRoll = (e.gamma * filter) + (smoothedRoll * (1 - filter));
                document.getElementById('crosshair').style.borderColor = Math.abs(smoothedRoll) < 5 ? "#2ecc71" : "#ff4757";
            });
            step = 1; updateUI();
            requestAnimationFrame(drawLoop);
        } catch (err) { alert("Camera/Sensors required."); }
    }

    function drawLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const horizonDiff = (smoothedPitch - offset) - 90; 
        const horizonY = (canvas.height / 2) + ((horizonDiff / 50) * canvas.height);

        // Angle Display
        ctx.fillStyle = "white"; ctx.font = "14px monospace"; ctx.textAlign = "right";
        ctx.fillText(Math.abs(horizonDiff).toFixed(1) + "Â°", canvas.width - 20, canvas.height / 2);

        if (step >= 1) {
            ctx.fillStyle = "rgba(52, 152, 219, 0.8)";
            ctx.beginPath(); ctx.moveTo(canvas.width/2, horizonY);
            ctx.lineTo(canvas.width/2-20, horizonY+30); ctx.lineTo(canvas.width/2+20, horizonY+30);
            ctx.fill();
            ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.font = "10px Arial";
            ctx.fillText("HORIZON", canvas.width/2, horizonY + 45);
        }
        requestAnimationFrame(drawLoop);
    }

    function setFlat() { document.getElementById('ground-angle').value = 0; }
    function snapSlope() { document.getElementById('ground-angle').value = Math.abs(90 - smoothedPitch).toFixed(1); }
    
    function calibratePace() {
        let p = prompt("Walk 5 meters. How many steps did you take?");
        if(p) document.getElementById('pace-val').value = (5 / parseInt(p)).toFixed(2);
    }

    function saveImage() {
        html2canvas(document.querySelector("#capture-area")).then(canvas => {
            let link = document.createElement('a');
            link.download = 'tree_height.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function handleMainAction() {
        if (step === 0) startApp();
        else if (step === 1) {
            angleTop = smoothedPitch - offset;
            const s = parseFloat(document.getElementById('step-count').value);
            const p = parseFloat(document.getElementById('pace-val').value);
            const g = parseFloat(document.getElementById('ground-angle').value) * (Math.PI / 180);
            const horizDist = (s * p) * Math.cos(g);
            const height = (horizDist * Math.tan((angleTop - 90) * (Math.PI / 180))) + 1.6;
            document.getElementById('height-res').innerText = height.toFixed(2) + " m";
            document.getElementById('info-res').innerText = `Horiz Dist: ${horizDist.toFixed(1)}m`;
            step = 2;
        } else { step = 1; document.getElementById('height-res').innerText = "-- m"; }
        updateUI();
    }

    function updateUI() {
        mainBtn.innerText = (step === 1) ? "MARK TOP" : "RESET";
        mainBtn.className = (step === 1) ? "btn-measure" : "btn-reset";
    }
</script>
</body>
</html>
