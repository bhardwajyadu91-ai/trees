<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TreeHeight Pro - Fixed Horizon</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: white; overflow: hidden; touch-action: none; }
        #capture-area { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #readout { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 12px; border-radius: 15px; text-align: center; width: 85%; border: 1px solid #444; pointer-events: auto; }
        #height-res { font-size: 2.2em; font-weight: bold; color: #2ecc71; }
        #center-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #crosshair { width: 60px; height: 60px; border: 2px solid #ff4757; border-radius: 50%; position: relative; color: #ff4757; }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: currentColor; }
        #crosshair::before { top: 20%; left: 50%; width: 2px; height: 60%; transform: translateX(-50%); }
        #crosshair::after { top: 50%; left: 20%; width: 60%; height: 2px; transform: translateY(-50%); }
        #settings-panel { position: absolute; bottom: 110px; left: 15px; width: 62%; background: rgba(25, 25, 25, 0.95); padding: 12px; border-radius: 20px; border: 1px solid #555; pointer-events: auto; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; gap: 5px; }
        .group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .group span { font-size: 8px; text-transform: uppercase; opacity: 0.7; }
        input { background: rgba(255,255,255,0.1); border: none; border-radius: 5px; color: #2ecc71; font-weight: bold; text-align: center; font-size: 16px; width: 100%; padding: 4px 0; outline: none; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .small-btn { background: #444; padding: 10px 4px; border-radius: 8px; font-size: 9px; border: none; color: white; cursor: pointer; font-weight: bold; }
        #main-btn { position: absolute; bottom: 110px; right: 20px; width: 90px; height: 90px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); color: white; font-weight: bold; font-size: 14px; cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center; text-align: center; }
        .btn-measure { background: #2ecc71; }
        .btn-reset { background: #e67e22; }
    </style>
</head>
<body>

<div id="capture-area">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="hud">
        <div id="readout">
            <input type="text" id="species" placeholder="Tree Name..." style="background:none; border:none; color:#bbb; width:100%; text-align:center;">
            <div id="height-res">-- m</div>
            <div id="info-res" style="font-size: 10px; opacity: 0.6;">Hold Phone Level & Tap Start</div>
        </div>
        <div id="center-ui"><div id="crosshair"></div></div>
        <div id="settings-panel">
            <div class="row">
                <div class="group"><span>Dist (m)</span><input type="number" id="manual-dist" value="10"></div>
                <div class="group"><span>SlopeÂ°</span><input type="number" id="ground-angle" value="0"></div>
            </div>
            <div class="btn-grid">
                <button class="small-btn" onclick="setFlat()">FLAT (0Â°)</button>
                <button class="small-btn" onclick="snapSlope()">SNAP SLOPE</button>
                <button class="small-btn" style="grid-column: span 2; background:#8e44ad;" onclick="reZero()">RE-ZERO HORIZON</button>
                <button class="small-btn" style="grid-column: span 2; background:#2980b9;" onclick="saveImage()">ðŸ“¸ SAVE PHOTO</button>
            </div>
        </div>
        <button id="main-btn" class="btn-measure" onclick="handleMainAction()">START</button>
    </div>
</div>

<script>
    let step = 0, offset = 0, smoothedPitch = 0, filter = 0.15;
    const video = document.getElementById('video'), canvas = document.getElementById('overlay'), ctx = canvas.getContext('2d'), mainBtn = document.getElementById('main-btn');

    async function startApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            window.addEventListener('deviceorientation', (e) => {
                // Using beta (tilt forward/back)
                smoothedPitch = (e.beta * filter) + (smoothedPitch * (1 - filter));
                const roll = e.gamma;
                document.getElementById('crosshair').style.borderColor = Math.abs(roll) < 5 ? "#2ecc71" : "#ff4757";
            });
            // Auto-zero on start
            setTimeout(() => { reZero(); }, 500);
            step = 1; updateUI();
            requestAnimationFrame(drawLoop);
        } catch (err) { alert("Enable Sensors/Camera"); }
    }

    function reZero() {
        offset = smoothedPitch; // Sets current angle as the new 0
        console.log("Horizon Re-Zeroed at: " + offset);
    }

    function drawLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Calculate diff from the saved 0-point
        const horizonDiff = smoothedPitch - offset; 
        // Sensitivity adjustment: 40 degrees of tilt fills the screen
        const horizonY = (canvas.height / 2) + ((horizonDiff / 40) * canvas.height);
        const isCentered = Math.abs(horizonDiff) < 1.0;

        if (step >= 1) {
            ctx.fillStyle = isCentered ? "#f1c40f" : "#3498db";
            ctx.beginPath(); ctx.moveTo(canvas.width/2, horizonY);
            ctx.lineTo(canvas.width/2-20, horizonY+25); ctx.lineTo(canvas.width/2+20, horizonY+25);
            ctx.fill();
        }
        requestAnimationFrame(drawLoop);
    }

    function setFlat() { document.getElementById('ground-angle').value = 0; }
    function snapSlope() { document.getElementById('ground-angle').value = Math.abs(smoothedPitch - offset).toFixed(1); }

    function handleMainAction() {
        if (step === 0) startApp();
        else if (step === 1) {
            const dist = parseFloat(document.getElementById('manual-dist').value);
            const g = parseFloat(document.getElementById('ground-angle').value) * (Math.PI / 180);
            const hDist = dist * Math.cos(g);
            const angleFromHorizon = Math.abs(smoothedPitch - offset);
            const height = (hDist * Math.tan(angleFromHorizon * (Math.PI / 180))) + 1.6;
            document.getElementById('height-res').innerText = height.toFixed(2) + " m";
            step = 2;
        } else { step = 1; document.getElementById('height-res').innerText = "-- m"; }
        updateUI();
    }

    function saveImage() {
        html2canvas(document.querySelector("#capture-area")).then(canvas => {
            let link = document.createElement('a');
            link.download = 'Tree_Report.png'; link.href = canvas.toDataURL(); link.click();
        });
    }

    function updateUI() {
        mainBtn.innerHTML = (step === 1) ? "MARK<br>TOP" : "RESET";
        mainBtn.className = (step === 1) ? "btn-measure" : "btn-reset";
        document.getElementById('info-res').innerText = (step === 1) ? "Align Triangle inside Crosshair" : "Result Saved";
    }
</script>
</body>
</html>
